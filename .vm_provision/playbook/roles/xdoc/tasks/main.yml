---
- name: Clone xdoc source code
  git:
    repo: '{{ xdoc_repo.url }}'
    dest: '{{ xdoc_repo.dest }}'
    accept_hostkey: yes
    executable: /usr/bin/git
  become: true
  become_user: vagrant

- name: Install depedencies
  shell: 'yarn'
  args:
    chdir: '{{ xdoc_repo.dest }}'

- name: Pull icons shared files
  shell: 'git submodule update --init'
  args:
    chdir: '{{ xdoc_repo.dest }}'

- name: Configure doc resources
  block:
    - name: ensure dev source file exists
      file:
        path: '{{ xdoc_repo.dest }}/dev-sources.json'
        state: touch
    - name: Setup dev resources
      lineinfile:
        path: '{{ xdoc_repo.dest }}/dev-sources.json'
        line: '{"docs": false, "k8s_docs": true, "barman": false}'
        state: present
    - name: Pull configured doc sources
      shell: 'yarn pull-sources'
      args:
        chdir: '{{ xdoc_repo.dest }}'

- name: Clean up workspace to wrap up
  shell: 'yarn clean'
  args:
    chdir: '{{ xdoc_repo.dest }}'
